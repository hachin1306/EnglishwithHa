<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Practice English with Hachin</title>
    <style>
        /* CSS D√ÄNH CHO GIAO DI·ªÜN CHUNG V√Ä C√ÅC TH√ÄNH PH·∫¶N */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; margin-bottom: 25px; } 
        
        /* Tab Controls */
        .tab-controls { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-button { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; transition: all 0.3s; color: #555; font-weight: 600; border-radius: 8px 8px 0 0; }
        .tab-button:hover { background-color: #e9ecef; }
        .tab-button.active { background-color: #007bff; color: white; border-radius: 8px 8px 0 0; }
        .tab-content { padding: 15px 0; }
        .tab-content.hidden { display: none; }

        /* Controls Area */
        #controls-area { padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; background-color: #f8f9fa; }
        
        /* CH·ªàNH S·ª¨A TI√äU ƒê·ªÄ B√ÄI H·ªåC */
        #current-story-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        #edit-story-btn { 
            display: none; 
            padding: 5px 10px; 
            background-color: #ffc107; 
            color: #333; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 10px;
        }

        /* Dictation & Controls */
        #user-input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .dictation-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .dictation-controls button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        #read-sentence-btn { background: none; border: none; cursor: pointer; font-size: 30px; color: #28a745; padding: 0; margin-right: 15px; transition: color 0.2s; }
        #feedback-area { margin-top: 15px; padding: 15px; border-radius: 6px; min-height: 50px; background-color: #e9ecef; }
        .correct { color: #28a745; font-weight: bold; }
        .incorrect { color: #dc3545; font-weight: bold; text-decoration: underline; }
        
        /* Transcript */
        #transcript-list { list-style: none; padding: 0; }
        #full-transcript-text { white-space: pre-wrap; font-size: 1.1em; line-height: 1.6; }
        .play-small-btn { background-color: #e6f0ff; border: 1px solid #007bff; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #007bff; font-size: 14px; padding-left: 3px; margin-right: 10px; }
        #transcript-list li { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 1.1em; }
        .highlight { background-color: #fff3cd; padding: 2px 4px; border-radius: 3px; }
        .sentence-highlight { background-color: #fff3cd; } 
        
        /* Notes & Manager */
        #user-notes { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; resize: vertical; font-size: 14px; }
        .manager-group { margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        
        /* ADMIN AUTH */
        #admin-auth { text-align: right; margin-bottom: 10px; display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        #admin-auth input { border: 1px solid #ccc; padding: 5px; width: 150px; }
        #admin-auth button { border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        #auth-btn { background-color: #007bff; color: white; }
        #toggle-admin-btn { background-color: #6c757d; color: white; display: none; }
        
        /* ·∫®n c√°c th√†nh ph·∫ßn Admin (s·∫Ω ƒë∆∞·ª£c JS m·ªü) */
        .admin-only { display: none; }
        
        /* Giao di·ªán t·∫°o b√†i h·ªçc m·ªõi (D√°n vƒÉn b·∫£n - Theo y√™u c·∫ßu) */
        .new-story-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap; 
        }
        .new-story-controls label {
            white-space: nowrap;
        }
        .new-story-controls input[type="text"] {
             flex: 1 1 200px; /* Cho ph√©p co gi√£n */
             padding: 8px; 
             border: 1px solid #ccc;
             border-radius: 4px;
        }
        #new-story-content {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            resize: vertical;
            font-size: 14px;
            margin-bottom: 10px;
        }
        #save-new-story-btn {
            float: right;
            padding: 10px 15px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            font-weight: bold;
        }
        #new-story-status {
            float: left;
            margin-top: 15px;
        }

        /* KH√ìA CH·ª®C NƒÇNG ADMIN */
        .admin-lock {
            pointer-events: none;
            opacity: 0.6;
        }
        .admin-lock button {
            cursor: default !important;
        }


        /* AUDIO MOCK */
        #audio-player-mock { 
            display: flex; align-items: center; background: #e0e0e0; padding: 10px; border-radius: 8px; margin-bottom: 15px;
            opacity: 1; 
        }
        .play-btn-mock { font-size: 24px; cursor: pointer; margin-right: 10px; color: #007bff; }
        .time-mock { font-size: 14px; margin-right: 10px; }
        .progress-bar-mock { flex-grow: 1; height: 8px; background: #ccc; border-radius: 4px; overflow: hidden; }
        .progress-mock { height: 100%; width: 0%; background: #28a745; transition: width 0.1s linear; }
        .volume-mock { margin-left: 10px; font-size: 16px; }

        /* STORIES LIST */
        .story-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 0; 
            border-bottom: 1px dotted #eee;
            cursor: pointer; 
        }
        .story-title-link {
            text-decoration: none;
            color: #333;
            flex-grow: 1;
            cursor: pointer; 
        }
        .story-title-link:hover {
            color: #007bff;
            text-decoration: underline;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <h1 id="main-title">Practice English with Hachin</h1>

        <div id="admin-auth">
            <input type="password" id="admin-password" placeholder="M·∫≠t kh·∫©u Admin">
            <button id="auth-btn" onclick="checkAdminPassword()">ƒêƒÉng nh·∫≠p Admin</button>
            <button id="toggle-admin-btn" onclick="toggleAdminMode()"></button>
            <span id="auth-status" style="margin-left: 10px; font-size: 0.9em;"></span>
        </div>

        <div class="tab-controls">
            <button class="tab-button active" onclick="openTab('dictiation-page', this)">Dictiation</button>
            <button class="tab-button" onclick="openTab('transcript-page', this)">Full Transcript</button>
            <button class="tab-button" onclick="openTab('manager', this)">B√†i h·ªçc</button> 
        </div>

        <div id="controls-area">
            <div id="current-story-container">
                <p style="margin: 0;">B√†i h·ªçc ƒëang m·ªü: <strong id="current-story-title">Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c ch·ªçn.</strong></p>
                <button id="edit-story-btn" style="display: none;" onclick="prepareToEditStory()">S·ª≠a B√†i H·ªçc N√†y</button>
            </div>
            
            <div class="speed-control control-group">
                <label for="speech-rate">T·ªëc ƒë·ªô ƒë·ªçc:</label>
                <input type="range" id="speech-rate" min="0.5" max="2" step="0.1" value="1.0">
                <span id="rate-display">1.0x</span>
            </div>
        </div>

        <div id="dictiation-page" class="tab-content">
            <div id="dictiation-content">
                <p>C√¢u hi·ªán t·∫°i: <span id="current-sentence-index">0</span> / <span id="total-sentences">0</span></p>
                
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <button id="read-sentence-btn" disabled>‚ñ∂</button>
                    <span style="font-size: 1.1em; font-weight: 500;">Nghe c√¢u</span>
                </div>
                
                <input type="text" id="user-input" placeholder="G√µ l·∫°i nh·ªØng g√¨ b·∫°n nghe...">
                
                <div class="dictation-controls">
                    <button id="check-btn" disabled>Check</button>
                    <button id="skip-btn" disabled>Skip</button>
                    <button id="next-play-btn" disabled>Next & Play</button>
                </div>
                
                <div id="feedback-area"></div>
                
                <div id="notes-area">
                    <h3>√î Ghi Ch√∫ C√° Nh√¢n</h3>
                    <textarea id="user-notes" placeholder="Ghi ch√∫ t·ª´ v·ª±ng, ng·ªØ ph√°p, hay b·∫•t c·ª© ƒëi·ªÅu g√¨ b·∫°n mu·ªën l∆∞u l·∫°i v·ªÅ b√†i h·ªçc n√†y..."></textarea>
                    <button onclick="saveNotes()" style="margin-top: 10px; padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 5px;">L∆∞u Ghi Ch√∫</button>
                    <p id="note-status" style="margin-top: 5px; font-size: 0.9em; color: green;"></p>
                </div>
            </div>
        </div>

        <div id="transcript-page" class="tab-content hidden">
             <div id="transcript-content">
                <h2>Full Transcript (Xem/Nghe)</h2>
                
                <div id="audio-player-mock">
                    <span class="play-btn-mock" id="full-play-btn" onclick="toggleFullPlay()">‚ñ∂</span>
                    <span class="time-mock" id="audio-time">0:00 / 0:00</span>
                    <div class="progress-bar-mock">
                        <div class="progress-mock" id="audio-progress"></div>
                    </div>
                    <span class="volume-mock">üîä</span>
                </div>
                
                <h3 style="margin-top: 20px;">T·ª´ng C√¢u</h3>
                
                <ul id="transcript-list">
                    <li>Ch∆∞a c√≥ n·ªôi dung b√†i h·ªçc. Vui l√≤ng t·∫£i b√†i h·ªçc.</li>
                </ul>
                
                <h3 style="margin-top: 30px;">To√†n b·ªô ƒêo·∫°n VƒÉn b·∫£n</h3>
                <div id="full-transcript-text"></div>
            </div>
        </div>

        <div id="manager" class="tab-content hidden">
            <div class="manager-group" id="create-new-story-section">
                <h2>T·∫°o B√†i H·ªçc M·ªõi</h2>
                
                <div id="new-story-input-area" class="admin-lock">
                    <div class="new-story-controls">
                        <button onclick="resetNewStoryForm()" style="padding: 10px 15px; background-color: #20c997; color: white; border: none; border-radius: 5px; font-weight: bold;" disabled>+ T·∫°o B√†i H·ªçc M·ªõi (Reset Form)</button>
                        
                        <label for="new-story-title">T√™n B√†i H·ªçc:</label>
                        <input type="text" id="new-story-title" 
                            placeholder="Ch·ª©c nƒÉng n√†y ch·ªâ d√†nh cho ch·ªß ·ª©ng d·ª•ng (Admin)."
                            title="ƒêƒÉng nh·∫≠p Admin ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y.">
                        
                        <label for="new-story-content">N·ªôi dung B√†i H·ªçc (Full Transcript):</label>
                    </div>
                    
                    <textarea id="new-story-content" 
                        placeholder="Ch·ª©c nƒÉng n√†y ch·ªâ d√†nh cho ch·ªß ·ª©ng d·ª•ng (Admin)." 
                        title="ƒêƒÉng nh·∫≠p Admin ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y."></textarea>
                    
                    <button id="save-new-story-btn" onclick="createNewStory()" disabled>L∆∞u B√†i H·ªçc</button>
                    <p id="new-story-status" style="margin-top: 10px; font-size: 0.9em;"></p>
                    <div style="clear: both;"></div> 
                </div>

                <p id="admin-message" style="margin-top: 10px; color: red; font-weight: bold; text-align: center;">
                    ƒê·ªÇ TH√äM/S·ª¨A B√ÄI H·ªåC, VUI L√íNG D√ôNG T√çNH NƒÇNG ƒêƒÇNG NH·∫¨P ADMIN ·ªû PH√çA TR√äN.
                </p>
            </div>
            
            <div class="manager-group admin-only" id="edit-story-section" style="display: none;">
                <h2>Ch·ªânh S·ª≠a B√†i H·ªçc: <span id="editing-story-title"></span></h2>
                <input type="text" id="edit-story-title" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc;">
                
                <label for="edit-story-content">N·ªôi dung B√†i H·ªçc (Full Transcript):</label>
                <textarea id="edit-story-content" style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; resize: vertical; font-size: 14px; margin-bottom: 10px;"></textarea>
                
                <button onclick="updateStory()" style="padding: 10px 15px; background-color: #17a2b8; color: white; border: none; border-radius: 5px; font-weight: bold;">C·∫≠p Nh·∫≠t B√†i H·ªçc</button>
                <button onclick="cancelEdit()" style="padding: 10px 15px; background-color: #dc3545; color: white; border: none; border-radius: 5px; font-weight: bold; margin-left: 10px;">H·ªßy B·ªè</button>
                <p id="edit-story-status" style="margin-top: 10px; font-size: 0.9em;"></p>
            </div>

            <div class="manager-group">
                <h2>B√†i H·ªçc ƒê√£ L∆∞u (B·∫•m ƒë·ªÉ T·∫£i)</h2>
                
                <div id="saved-stories-list">
                    </div>
            </div>
        </div>

    </div>

    <script>
        // *** KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C ***
        let currentStory = null;
        let sentences = [];
        let currentSentenceIndex = -1;
        const synth = window.speechSynthesis;
        let voices = [];
        let englishVoice = null;
        const adminPass = "Hachin@1306"; 
        let isAdmin = false;
        
        // Tr·∫°ng th√°i cho Full Playback
        let fullPlaybackInterval = null;
        let isFullPlaying = false;
        let currentFullSentenceIndex = 0;
        let currentFullTime = 0;
        let startTime = 0;
        let totalDuration = 0; 
        let totalDurationDisplay = "0:00"; 


        // *** H√ÄM L·∫§Y GI·ªåNG ƒê·ªåC V√Ä KH·ªûI T·∫†O ***
        function populateVoices() {
            voices = synth.getVoices();
            englishVoice = voices.find(voice => voice.lang.startsWith('en-US') || voice.lang.startsWith('en-GB'));
            
            if (!englishVoice) {
                englishVoice = voices.find(voice => voice.lang.startsWith('en'));
            }
            if (englishVoice) {
                 console.log("ƒê√£ ch·ªçn gi·ªçng ƒë·ªçc:", englishVoice.name);
            }
        }
        
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = populateVoices;
        } else {
            populateVoices();
        }


        // *** C√ÅC H√ÄM TI·ªÜN √çCH ***
        
        function updateDictationControls(canControl) {
            document.getElementById('check-btn').disabled = !canControl;
            document.getElementById('skip-btn').disabled = !canControl;
            document.getElementById('next-play-btn').disabled = !canControl;
            document.getElementById('read-sentence-btn').disabled = !canControl;
        }

        function speak(text, rate, callback, isFullPlay = false) {
            if (!synth) {
                console.error("Speech Synthesis API kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£.");
                if (callback) callback(); 
                return;
            }
            
            if (!isFullPlay) {
                synth.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = rate;
            
            if (englishVoice) {
                utterance.voice = englishVoice;
            }
            utterance.lang = 'en-US'; 
            
            utterance.onend = () => {
                if (callback) callback();
            };
            
            utterance.onerror = (event) => {
                 console.error('L·ªói Speech Synthesis:', event.error);
                 if (callback) callback();
            };
            
            synth.speak(utterance);
        }

        // T·∫£i danh s√°ch b√†i h·ªçc ƒë√£ l∆∞u t·ª´ LocalStorage
        function loadSavedStories() {
            const stories = JSON.parse(localStorage.getItem('savedStories')) || {};
            const listContainer = document.getElementById('saved-stories-list');
            listContainer.innerHTML = '';
            
            const titles = Object.keys(stories);

            if (titles.length === 0) {
                listContainer.innerHTML = '<p>Ch∆∞a c√≥ b√†i h·ªçc n√†o ƒë∆∞·ª£c l∆∞u. (Ho·∫∑c b·∫•m ƒêƒÉng nh·∫≠p Admin ƒë·ªÉ t·∫°o b√†i m·ªõi)</p>';
                return;
            }
            
            // S·∫Øp x·∫øp: B√†i h·ªçc m·∫´u l√™n ƒë·∫ßu
            titles.sort((a, b) => {
                if (a === "The Snow Day") return -1;
                if (b === "The Snow Day") return 1;
                return a.localeCompare(b);
            });

            titles.forEach(title => {
                const story = stories[title];
                
                const storyDiv = document.createElement('div');
                storyDiv.className = 'story-item';
                
                // G√°n Event Listener ƒë·ªÉ ch·ªçn b√†i h·ªçc v√†o DIV cha
                storyDiv.addEventListener('click', () => {
                    document.getElementById('edit-story-section').style.display = 'none';
                    // ƒê·∫£m b·∫£o khu v·ª±c t·∫°o b√†i m·ªõi hi·ªán l·∫°i n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô Admin
                    if (isAdmin) {
                         document.getElementById('create-new-story-section').style.display = ''; 
                    }
                    loadStory(title);
                });
                
                // --- 1. Link B√†i H·ªçc (Ch·ª©c nƒÉng ch·ªçn b√†i) ---
                const titleLink = document.createElement('span'); 
                titleLink.className = 'story-title-link';
                titleLink.textContent = title;
                if (title === "The Snow Day") {
                     titleLink.textContent += " (B√†i h·ªçc m·∫´u)";
                }
                
                storyDiv.appendChild(titleLink);

                // --- 2. N√∫t X√≥a (Admin Only) ---
                // Ch·ªâ t·∫°o n√∫t x√≥a n·∫øu l√† Admin
                if (isAdmin) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'X√≥a';
                    deleteBtn.style.backgroundColor = '#dc3545';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.padding = '5px 10px';
                    deleteBtn.style.borderRadius = '4px';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.style.marginLeft = '10px';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation(); 
                        deleteStory(title);
                    }
                    storyDiv.appendChild(deleteBtn);
                }

                listContainer.appendChild(storyDiv);
            });
        }

        function saveNotes() {
            if (!currentStory) {
                document.getElementById('note-status').textContent = "Vui l√≤ng t·∫£i m·ªôt b√†i h·ªçc tr∆∞·ªõc.";
                document.getElementById('note-status').style.color = 'red';
                return;
            }
            const notes = localStorage.getItem(`notes_${currentStory.title}`) || '';
            const newNotes = document.getElementById('user-notes').value;
            
            if (newNotes === notes) {
                document.getElementById('note-status').textContent = "Ghi ch√∫ kh√¥ng thay ƒë·ªïi.";
                document.getElementById('note-status').style.color = 'orange';
            } else {
                localStorage.setItem(`notes_${currentStory.title}`, newNotes);
                document.getElementById('note-status').textContent = "ƒê√£ l∆∞u ghi ch√∫ th√†nh c√¥ng!";
                document.getElementById('note-status').style.color = 'green';
            }
            setTimeout(() => document.getElementById('note-status').textContent = '', 3000);
        }

        function loadNotes() {
            if (currentStory) {
                const notes = localStorage.getItem(`notes_${currentStory.title}`) || '';
                document.getElementById('user-notes').value = notes;
            } else {
                document.getElementById('user-notes').value = '';
            }
            document.getElementById('note-status').textContent = '';
        }

        function updateTranscriptList() {
            const list = document.getElementById('transcript-list');
            list.innerHTML = '';

            if (sentences.length === 0) {
                list.innerHTML = '<li>Ch∆∞a c√≥ n·ªôi dung b√†i h·ªçc. Vui l√≤ng t·∫£i b√†i h·ªçc.</li>';
                document.getElementById('full-transcript-text').textContent = '';
                return;
            }

            let fullText = '';
            sentences.forEach((sentence, index) => {
                const li = document.createElement('li');
                li.id = `full-s-${index}`; 

                const playBtn = document.createElement('span');
                playBtn.className = 'play-small-btn';
                playBtn.innerHTML = '‚ñ∂';
                playBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    const rate = parseFloat(document.getElementById('speech-rate').value);
                    speak(sentence, rate);
                };

                const textSpan = document.createElement('span');
                textSpan.textContent = sentence;
                
                if (index === currentSentenceIndex) {
                    textSpan.classList.add('highlight');
                } else {
                    textSpan.classList.remove('highlight');
                }
                
                if (index === currentFullSentenceIndex && isFullPlaying) {
                    li.classList.add('sentence-highlight');
                } else {
                    li.classList.remove('sentence-highlight');
                }

                li.appendChild(playBtn);
                li.appendChild(textSpan);
                list.appendChild(li);
                
                fullText += sentence + (index < sentences.length - 1 ? '\n' : '');
            });
            
            document.getElementById('full-transcript-text').textContent = fullText;
        }

        // *** CH·ª®C NƒÇNG CH√çNH: DICTATION ***

        function loadStory(title) {
            resetFullAudioMock();
            if (synth.speaking) synth.cancel();
            
            const stories = JSON.parse(localStorage.getItem('savedStories')) || {};
            const story = stories[title];

            if (!story) {
                console.error("Kh√¥ng t√¨m th·∫•y b√†i h·ªçc:", title);
                return;
            }

            currentStory = story;
            sentences = currentStory.content.split('\n').filter(s => s.trim() !== '');
            currentSentenceIndex = -1; 
            currentFullSentenceIndex = 0; 
            
            totalDuration = sentences.length * 3; 
            totalDurationDisplay = formatTime(totalDuration);

            document.getElementById('current-story-title').textContent = title;
            document.getElementById('page-title').textContent = `${title} | Hachin Dictation`;
            document.getElementById('total-sentences').textContent = sentences.length;
            document.getElementById('current-sentence-index').textContent = 0;
            document.getElementById('user-input').value = '';
            document.getElementById('feedback-area').innerHTML = '';
            
            loadNotes();
            updateTranscriptList();
            
            nextSentence(false); 
            openTab('dictiation-page', document.querySelector('.tab-button:first-child'));
            
            document.getElementById('edit-story-btn').style.display = (isAdmin && currentStory) ? 'inline-block' : 'none';
        }

        function nextSentence(playAudio = true) {
            currentSentenceIndex++;

            if (currentSentenceIndex >= sentences.length) {
                document.getElementById('feedback-area').innerHTML = '<p style="color: #007bff; font-size: 1.2em;">üéâ **Ho√†n th√†nh b√†i h·ªçc!** B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u.</p>';
                document.getElementById('current-sentence-index').textContent = sentences.length;
                updateDictationControls(false); 
                return;
            }

            const currentSentence = sentences[currentSentenceIndex];
            
            document.getElementById('user-input').value = '';
            document.getElementById('user-input').focus();
            document.getElementById('feedback-area').innerHTML = '';
            document.getElementById('current-sentence-index').textContent = currentSentenceIndex + 1;
            updateDictationControls(true);
            updateTranscriptList(); 

            if (playAudio) {
                const rate = parseFloat(document.getElementById('speech-rate').value);
                speak(currentSentence, rate);
            }
        }

        function checkInput() {
            if (currentSentenceIndex < 0 || currentSentenceIndex >= sentences.length) return;

            const expected = sentences[currentSentenceIndex].trim().toLowerCase().replace(/[^a-z0-9\s]/g, '');
            const actual = document.getElementById('user-input').value.trim().toLowerCase().replace(/[^a-z0-9\s]/g, '');
            const originalSentence = sentences[currentSentenceIndex];
            
            let feedbackHTML = '';

            if (expected === actual) {
                feedbackHTML = `<p class="correct">Ch√≠nh x√°c!</p>`;
                document.getElementById('feedback-area').innerHTML = feedbackHTML;
                nextSentence(false); 
            } else {
                const wordsExpected = originalSentence.split(/\s+/).filter(w => w !== '');
                const wordsActual = document.getElementById('user-input').value.trim().split(/\s+/).filter(w => w !== '');
                
                let correctedHTML = '';
                
                for (let i = 0; i < wordsExpected.length; i++) {
                    const expectedWord = wordsExpected[i];
                    
                    const expectedWordClean = expectedWord.toLowerCase().replace(/[^a-z0-9]/g, '');
                    
                    let actualWord = wordsActual[i];
                    let actualWordClean = actualWord ? actualWord.toLowerCase().replace(/[^a-z0-9]/g, '') : '';
                    
                    if (!actualWord || expectedWordClean !== actualWordClean) {
                        correctedHTML += `<span class="incorrect">${expectedWord}</span> `;
                    } else {
                        correctedHTML += `${expectedWord} `;
                    }
                }
                
                feedbackHTML = `
                    <p class="incorrect">Sai r·ªìi. H√£y th·ª≠ l·∫°i ho·∫∑c b·∫•m Skip.</p>
                    <p>G·ª£i √Ω: ${correctedHTML.trim()}</p>
                `;
                document.getElementById('feedback-area').innerHTML = feedbackHTML;
            }
        }

        function skipSentence() {
            if (currentSentenceIndex < 0 || currentSentenceIndex >= sentences.length) return;
            const originalSentence = sentences[currentSentenceIndex];
            document.getElementById('feedback-area').innerHTML = `
                <p>B·∫°n ƒë√£ b·ªè qua. C√¢u ch√≠nh x√°c l√†:</p>
                <p style="font-weight: bold; color: #007bff;">${originalSentence}</p>
            `;
            nextSentence(false); 
        }

        // *** CH·ª®C NƒÇNG FULL TRANSCRIPT (MOCK AUDIO) ***
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${min}:${sec}`;
        }
        
        function readNextFullSentence() {
            if (!isFullPlaying || currentFullSentenceIndex >= sentences.length) {
                if(currentFullSentenceIndex >= sentences.length) toggleFullPlay(); 
                return;
            }
            
            const sentence = sentences[currentFullSentenceIndex];
            const rate = parseFloat(document.getElementById('speech-rate').value);
            
            updateTranscriptList(); 
            
            const currentLi = document.getElementById(`full-s-${currentFullSentenceIndex}`);
            if (currentLi) {
                currentLi.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
            }
            
            speak(sentence, rate, () => {
                currentFullSentenceIndex++;
                readNextFullSentence();
            }, true); 
        }

        function toggleFullPlay() {
            const playBtn = document.getElementById('full-play-btn');
            
            if (sentences.length === 0) {
                 document.getElementById('audio-time').textContent = "Ch∆∞a c√≥ b√†i h·ªçc";
                return;
            }

            if (isFullPlaying) {
                // PAUSE
                clearInterval(fullPlaybackInterval);
                synth.cancel(); 
                playBtn.textContent = '‚ñ∂';
                isFullPlaying = false;
                updateTranscriptList(); 
            } else {
                // PLAY
                if (currentFullSentenceIndex >= sentences.length) {
                    currentFullSentenceIndex = 0; 
                    currentFullTime = 0;
                }
                
                playBtn.textContent = '‚è∏';
                isFullPlaying = true;
                startTime = performance.now() - currentFullTime * 1000; 
                
                readNextFullSentence();

                fullPlaybackInterval = setInterval(() => {
                    const elapsedTime = (performance.now() - startTime) / 1000;
                    currentFullTime = elapsedTime;

                    if (currentFullTime >= totalDuration) {
                        currentFullTime = totalDuration;
                        toggleFullPlay(); 
                    }

                    const progress = (currentFullTime / totalDuration) * 100;
                    document.getElementById('audio-progress').style.width = `${progress}%`;
                    document.getElementById('audio-time').textContent = `${formatTime(currentFullTime)} / ${totalDurationDisplay}`;
                }, 100); 
            }
        }
        
        function resetFullAudioMock() {
             clearInterval(fullPlaybackInterval);
             synth.cancel(); 
             isFullPlaying = false;
             currentFullTime = 0;
             currentFullSentenceIndex = 0;
             document.getElementById('full-play-btn').textContent = '‚ñ∂';
             document.getElementById('audio-progress').style.width = `0%`;
             document.getElementById('audio-time').textContent = sentences.length > 0 ? `0:00 / ${totalDurationDisplay}` : `0:00 / 0:00`;
             updateTranscriptList(); 
        }


        // *** CH·ª®C NƒÇNG ADMIN & L∆ØU B√ÄI H·ªåC ***

        function toggleAdminControls(enable) {
            const newStoryArea = document.getElementById('new-story-input-area');
            const editStoryBtn = document.getElementById('edit-story-btn');
            const adminMessage = document.getElementById('admin-message');

            if (enable) {
                // B·∫≠t ch·∫ø ƒë·ªô Admin
                newStoryArea.classList.remove('admin-lock');
                newStoryArea.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false);
                adminMessage.style.display = 'none';
                if (currentStory) editStoryBtn.style.display = 'inline-block';
                
            } else {
                // T·∫Øt ch·∫ø ƒë·ªô Admin (Ch·∫ø ƒë·ªô ng∆∞·ªùi d√πng)
                newStoryArea.classList.add('admin-lock');
                newStoryArea.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true);
                adminMessage.style.display = 'block';
                editStoryBtn.style.display = 'none';
            }
        }

        function toggleAdminMode() {
            if (synth.speaking) synth.cancel();
            
            isAdmin = !isAdmin;
            document.getElementById('admin-password').style.display = isAdmin ? 'none' : 'inline-block';
            document.getElementById('auth-btn').style.display = isAdmin ? 'none' : 'inline-block';
            
            // X·ª≠ l√Ω c√°c Admin elements chung (N√∫t x√≥a, khu v·ª±c ch·ªânh s·ª≠a)
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = isAdmin ? '' : 'none'; 
            });
            
            // X·ª≠ l√Ω khu v·ª±c t·∫°o b√†i h·ªçc m·ªõi
            toggleAdminControls(isAdmin);
            
            // ƒê·∫£m b·∫£o khu v·ª±c Edit Story b·ªã ·∫©n (ch·ªâ hi·ªán khi b·∫•m S·ª≠a b√†i)
            document.getElementById('edit-story-section').style.display = 'none';
            
            // X·ª≠ l√Ω n√∫t toggle
            document.getElementById('toggle-admin-btn').style.display = 'inline-block';
            document.getElementById('toggle-admin-btn').textContent = isAdmin ? 'Tho√°t Admin' : 'ƒêƒÉng nh·∫≠p Admin';
            document.getElementById('auth-status').textContent = isAdmin ? 'ƒê√£ ƒëƒÉng nh·∫≠p Admin' : '';

            // T·∫£i l·∫°i danh s√°ch ƒë·ªÉ hi·ªán/·∫©n n√∫t X√≥a
            loadSavedStories();
            // ƒê·∫£m b·∫£o n√∫t S·ª≠a B√†i H·ªçc ·ªü khu v·ª±c Control ho·∫°t ƒë·ªông ƒë√∫ng
            document.getElementById('edit-story-btn').style.display = (isAdmin && currentStory) ? 'inline-block' : 'none';
        }

        function checkAdminPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === adminPass) {
                toggleAdminMode();
            } else {
                document.getElementById('auth-status').textContent = 'M·∫≠t kh·∫©u sai!';
                document.getElementById('auth-status').style.color = 'red';
            }
            document.getElementById('admin-password').value = '';
        }

        function resetNewStoryForm() {
            if (!isAdmin) return;
            document.getElementById('new-story-title').value = '';
            document.getElementById('new-story-content').value = '';
            document.getElementById('new-story-status').textContent = '';
        }

        function createNewStory() {
            if (!isAdmin) return;
            const titleInput = document.getElementById('new-story-title');
            const contentInput = document.getElementById('new-story-content');
            const status = document.getElementById('new-story-status');
            
            let title = titleInput.value.trim();
            let content = contentInput.value.trim();

            if (!title) {
                 status.textContent = 'Vui l√≤ng nh·∫≠p T√™n B√†i H·ªçc.';
                 status.style.color = 'red';
                 return;
            }
            
            if (!content) {
                status.textContent = 'Vui l√≤ng d√°n N·ªôi dung B√†i H·ªçc (Full Transcript).';
                status.style.color = 'red';
                return;
            }

            let stories = JSON.parse(localStorage.getItem('savedStories')) || {};
            let finalTitle = title;
            let count = 1;
            
            // Tr√°nh tr√πng l·∫∑p t√™n b√†i h·ªçc
            while (stories[finalTitle]) {
                finalTitle = `${title} (${count})`;
                count++;
            }

            stories[finalTitle] = { title: finalTitle, content: content };
            localStorage.setItem('savedStories', JSON.stringify(stories));

            status.textContent = `ƒê√£ l∆∞u b√†i h·ªçc "${finalTitle}" th√†nh c√¥ng!`;
            status.style.color = 'green';
            
            // Reset form
            resetNewStoryForm(); 
            
            loadSavedStories();
        }

        function deleteStory(title) {
            if (!isAdmin) return;
            if (title === "The Snow Day") { alert("Kh√¥ng ƒë∆∞·ª£c ph√©p x√≥a b√†i h·ªçc m·∫´u."); return; }
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i h·ªçc "${title}"?`)) return;

            let stories = JSON.parse(localStorage.getItem('savedStories')) || {};
            delete stories[title];
            localStorage.removeItem(`notes_${title}`); 
            localStorage.setItem('savedStories', JSON.stringify(stories));
            
            loadSavedStories();
            
            if (currentStory && currentStory.title === title) {
                currentStory = null;
                sentences = [];
                currentSentenceIndex = -1;
                document.getElementById('current-story-title').textContent = 'Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c ch·ªçn.';
                document.getElementById('total-sentences').textContent = 0;
                document.getElementById('current-sentence-index').textContent = 0;
                document.getElementById('user-input').value = '';
                document.getElementById('feedback-area').innerHTML = '';
                document.getElementById('edit-story-btn').style.display = 'none';
                updateTranscriptList();
                loadNotes();
                resetFullAudioMock();
            }
        }
        
        function prepareToEditStory() {
            if (!currentStory || !isAdmin) return;
            openTab('manager', document.querySelector('.tab-button:nth-child(3)'));
            // ·∫®n khu v·ª±c T·∫°o b√†i m·ªõi
            document.getElementById('create-new-story-section').style.display = 'none';
            // Hi·ªán khu v·ª±c S·ª≠a b√†i
            document.getElementById('edit-story-section').style.display = ''; 
            
            document.getElementById('editing-story-title').textContent = currentStory.title;
            document.getElementById('edit-story-title').value = currentStory.title;
            document.getElementById('edit-story-content').value = currentStory.content;
            document.getElementById('edit-story-status').textContent = '';
        }

        function updateStory() {
            if (!isAdmin) return;
            const oldTitle = currentStory.title;
            const newTitle = document.getElementById('edit-story-title').value.trim();
            const newContent = document.getElementById('edit-story-content').value.trim();
            const status = document.getElementById('edit-story-status');

            if (!newTitle || !newContent) {
                status.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√™n v√† N·ªôi dung B√†i H·ªçc.';
                status.style.color = 'red';
                return;
            }

            let stories = JSON.parse(localStorage.getItem('savedStories')) || {};
            
            if (oldTitle !== newTitle) {
                if (stories[newTitle]) {
                    status.textContent = 'T√™n b√†i h·ªçc m·ªõi ƒë√£ b·ªã tr√πng. Vui l√≤ng ch·ªçn t√™n kh√°c.';
                    status.style.color = 'red';
                    return;
                }
                // X√≥a b√†i c≈© v√† ghi ch√∫ c≈©
                delete stories[oldTitle];
                localStorage.removeItem(`notes_${oldTitle}`); 
            }
            
            stories[newTitle] = { title: newTitle, content: newContent };
            localStorage.setItem('savedStories', JSON.stringify(stories));

            loadStory(newTitle); 
            
            status.textContent = `ƒê√£ c·∫≠p nh·∫≠t b√†i h·ªçc "${newTitle}" th√†nh c√¥ng!`;
            status.style.color = 'green';
            
            cancelEdit();
        }

        function cancelEdit() {
            document.getElementById('edit-story-section').style.display = 'none';
            // ƒê·∫£m b·∫£o khu v·ª±c t·∫°o b√†i m·ªõi ƒë∆∞·ª£c hi·ªÉn th·ªã l·∫°i 
            document.getElementById('create-new-story-section').style.display = ''; 
            document.getElementById('edit-story-btn').style.display = (isAdmin && currentStory) ? 'inline-block' : 'none';
        }

        // *** C√ÄI ƒê·∫∂T M·∫∂C ƒê·ªäNH & INIT ***

        function setupSampleStory() {
            const stories = JSON.parse(localStorage.getItem('savedStories')) || {};
            if (!stories["The Snow Day"]) {
                const sampleContent = `Today is November 26th.
It snowed all day today.
The snow is beautiful.
The snow finally stopped.
My sister and I are excited.
My mom doesn't like the snow.
My mom has to shovel the driveway.
My sister and I get to play.
I put on my hat and mittens.
My mom puts on my scarf.
My mom zippers my jacket.
My sister puts on her hat and mittens.
My mom puts on her scarf.
My mom zippers her jacket.
My sister and I go outside.
We begin to make a snowman.
My mom starts to shovel the snow.
My sister and I make snow angels.
My sister and I throw snowballs.
It starts to snow again.
We go inside for hot chocolate.`;
                stories["The Snow Day"] = { title: "The Snow Day", content: sampleContent }; 
                localStorage.setItem('savedStories', JSON.stringify(stories));
            }
        }


        function openTab(tabId, buttonElement) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            buttonElement.classList.add('active');
            
            if (tabId !== 'transcript-page') {
                resetFullAudioMock();
            } else {
                updateTranscriptList(); 
            }
            
             if (tabId === 'manager') {
                document.getElementById('edit-story-btn').style.display = 'none';
                loadSavedStories(); 
                // Khi v√†o tab Manager, hi·ªÉn th·ªã khu v·ª±c T·∫°o b√†i m·ªõi v√† ·∫©n khu v·ª±c S·ª≠a b√†i (ch·ªâ hi·ªán khi b·∫•m S·ª≠a)
                document.getElementById('create-new-story-section').style.display = '';
                document.getElementById('edit-story-section').style.display = 'none'; 
            } else if (tabId === 'dictiation-page') {
                 document.getElementById('edit-story-btn').style.display = (isAdmin && currentStory) ? 'inline-block' : 'none';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setupSampleStory();
            
            document.getElementById('check-btn').onclick = checkInput;
            document.getElementById('user-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkInput();
            });

            document.getElementById('skip-btn').onclick = skipSentence;
            document.getElementById('next-play-btn').onclick = () => nextSentence(true);
            document.getElementById('read-sentence-btn').onclick = () => {
                if (currentSentenceIndex >= 0 && currentSentenceIndex < sentences.length) {
                    const rate = parseFloat(document.getElementById('speech-rate').value);
                    speak(sentences[currentSentenceIndex], rate);
                }
            };
            
            const rateInput = document.getElementById('speech-rate');
            const rateDisplay = document.getElementById('rate-display');
            rateInput.addEventListener('input', () => {
                rateDisplay.textContent = `${rateInput.value}x`;
            });
            
            populateVoices(); 
            loadSavedStories();
            // L·∫ßn ƒë·∫ßu t·∫£i b√†i m·∫´u
            const stories = JSON.parse(localStorage.getItem('savedStories')) || {};
            const defaultTitle = stories['The Snow Day'] ? 'The Snow Day' : Object.keys(stories)[0];
            if (defaultTitle) {
                loadStory(defaultTitle);
            } else {
                 // N·∫øu kh√¥ng c√≥ b√†i n√†o, hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh
                 document.getElementById('current-story-title').textContent = 'Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c ch·ªçn.';
            }
            
            // Thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu: CH·∫æ ƒê·ªò NG∆Ø·ªúI D√ôNG (isAdmin = false)
            toggleAdminControls(false); 
            document.getElementById('toggle-admin-btn').textContent = 'ƒêƒÉng nh·∫≠p Admin';
            
            // ·∫®n khu v·ª±c ch·ªânh s·ª≠a ri√™ng bi·ªát
            document.getElementById('edit-story-section').style.display = 'none';
        });

    </script>
</body>
</html>
