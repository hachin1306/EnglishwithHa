<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice English with Hachin</title>
    <style>
        /* CSS D√ÄNH CHO GIAO DI·ªÜN CHUNG V√Ä C√ÅC TH√ÄNH PH·∫¶N */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #007bff; margin-bottom: 25px; }
        
        /* Tab Controls */
        .tab-controls { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-button { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; transition: all 0.3s; color: #555; font-weight: 600; border-radius: 8px 8px 0 0; }
        .tab-button:hover { background-color: #e9ecef; }
        .tab-button.active { background-color: #007bff; color: white; border-radius: 8px 8px 0 0; }
        .tab-content { padding: 15px 0; }
        .tab-content.hidden { display: none; }

        /* Controls Area */
        #controls-area { padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; background-color: #f8f9fa; }
        .control-group { margin-bottom: 10px; }
        .speed-control label { margin-right: 10px; font-weight: 600; }

        /* Dictation */
        #dictiation-content { padding: 20px 0; }
        #dictiation-area p { font-size: 1.1em; margin-bottom: 15px; font-weight: 500; }
        #user-input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        
        .dictation-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .dictation-controls button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        
        /* N√∫t Nghe C√¢u (Play Icon) */
        #read-sentence-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 30px; 
            color: #28a745;
            padding: 0;
            margin-right: 15px;
            transition: color 0.2s;
        }
        #read-sentence-btn:hover { color: #218838; }
        
        #check-btn { background-color: #ffc107; color: #333; }
        #skip-btn { background-color: #17a2b8; color: white; }
        #next-play-btn { background-color: #007bff; color: white; } 
        #translate-btn { background-color: #6c757d; color: white; } 
        
        /* Feedback */
        #feedback-area { margin-top: 15px; padding: 15px; border-radius: 6px; min-height: 50px; background-color: #e9ecef; }
        .correct { color: #28a745; font-weight: bold; }
        .incorrect { color: #dc3545; font-weight: bold; text-decoration: underline; }
        .translation { background-color: #fff3cd; color: #333; margin-top: 10px; padding: 8px; border-radius: 4px; font-style: italic; }

        /* Full Transcript - Hi·ªÉn th·ªã t·ª´ng c√¢u */
        #transcript-content { padding: 20px 0; }
        #transcript-list { list-style: none; padding: 0; }
        #transcript-list li { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 1.1em; transition: background-color 0.2s; }
        
        .sentence-text { margin-left: 10px; flex-grow: 1; }
        .highlight { background-color: #fff3cd; padding: 2px 4px; border-radius: 3px; }

        /* Play Button nh·ªè */
        .play-small-btn { 
            background-color: #e6f0ff; 
            border: 1px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer; 
            color: #007bff; 
            font-size: 14px; 
            padding-left: 3px; 
            transition: all 0.2s;
        }
        .play-small-btn::before { content: '‚ñ∂'; } 
        .play-small-btn:hover { background-color: #cce0ff; }
        
        /* Thanh audio m√¥ ph·ªèng (Full Audio) */
        #audio-player-mock {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #audio-player-mock .play-btn-mock { font-size: 18px; cursor: pointer; color: #333; }
        #audio-player-mock .progress-bar-mock { flex-grow: 1; height: 6px; background-color: #ccc; border-radius: 3px; position: relative; }
        #audio-player-mock .progress-mock { width: 0%; height: 100%; background-color: #007bff; border-radius: 3px; }
        #audio-player-mock .time-mock { font-size: 12px; color: #555; white-space: nowrap; }
        #audio-player-mock .volume-mock { font-size: 16px; cursor: pointer; }

        /* Hi·ªÉn th·ªã to√†n b·ªô ƒëo·∫°n vƒÉn b·∫£n (Full Audio Text) */
        #full-transcript-text {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
            white-space: pre-wrap; /* Gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng xu·ªëng d√≤ng */
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px; 
        }


        /* NOTES & MANAGER CSS */
        #notes-area { margin-top: 30px; border-top: 2px solid #ddd; padding-top: 20px; }
        #user-notes { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; resize: vertical; font-size: 14px; }
        .manager-group { margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .manager-group h3 { color: #007bff; border-bottom: 1px dashed #ccc; padding-bottom: 10px; margin-top: 0; }
        #story-title-input { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        #new-transcript-input { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: vertical; font-size: 14px; }
        
        /* ·∫®N N√öT L∆ØU B√ÄI H·ªåC M·ªöI V√Ä N√öT X√ìA TRONG B·∫¢N C√îNG KHAI */
        #save-story-btn { display: none; } /* ·∫®N N√öT L∆ØU B√ÄI M·ªöI */
        .delete-btn { display: none; }     /* ·∫®N N√öT X√ìA B√ÄI H·ªåC C≈® */
        
        #saved-stories-list { list-style: none; padding: 0; }
        #saved-stories-list li { padding: 10px; margin-bottom: 8px; border: 1px solid #eee; border-radius: 6px; background-color: #fff; display: flex; justify-content: space-between; align-items: center; }
        .story-name { flex-grow: 1; cursor: pointer; color: #007bff; font-weight: 600; }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>Practice English with Hachin</h1>
        
        <div class="tab-controls">
            <button class="tab-button active" onclick="openTab('dictiation-page', this)">Dictiation</button>
            <button class="tab-button" onclick="openTab('transcript-page', this)">Full Transcript</button>
            <button class="tab-button" onclick="openTab('manager', this)">B√†i h·ªçc</button> </div>

        <div id="controls-area">
            <p>B√†i h·ªçc ƒëang m·ªü: <strong id="current-story-title">Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c ch·ªçn.</strong></p>
            <div class="speed-control control-group">
                <label for="speech-rate">T·ªëc ƒë·ªô ƒë·ªçc:</label>
                <input type="range" id="speech-rate" min="0.5" max="2" step="0.1" value="1.0">
                <span id="rate-display">1.0x</span>
            </div>
        </div>

        <div id="dictiation-page" class="tab-content">
            <div id="dictiation-content">
                <p>C√¢u hi·ªán t·∫°i: <span id="current-sentence-index">0</span> / <span id="total-sentences">0</span></p>
                
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <button id="read-sentence-btn" disabled>‚ñ∂</button>
                    <span style="font-size: 1.1em; font-weight: 500;">Nghe c√¢u</span>
                </div>
                
                <input type="text" id="user-input" placeholder="G√µ l·∫°i nh·ªØng g√¨ b·∫°n nghe...">
                
                <div class="dictation-controls">
                    <button id="check-btn" disabled>Check</button>
                    <button id="skip-btn" disabled>Skip</button>
                    <button id="next-play-btn" disabled>Next & Play</button>
                    <button id="translate-btn" disabled onclick="translateSentence()">D·ªãch C√¢u</button>
                </div>
                
                <div id="feedback-area"></div>
                
                <div id="notes-area">
                    <h3>√î Ghi Ch√∫ C√° Nh√¢n</h3>
                    <textarea id="user-notes" placeholder="Ghi ch√∫ t·ª´ v·ª±ng, ng·ªØ ph√°p, hay b·∫•t c·ª© ƒëi·ªÅu g√¨ b·∫°n mu·ªën l∆∞u l·∫°i v·ªÅ b√†i h·ªçc n√†y..."></textarea>
                    <button onclick="saveNotes()" style="margin-top: 10px; padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 5px;">L∆∞u Ghi Ch√∫</button>
                    <p id="note-status" style="margin-top: 5px; font-size: 0.9em; color: green;"></p>
                </div>
            </div>
        </div>

        <div id="transcript-page" class="tab-content hidden">
            <div id="transcript-content">
                <h2>Full Transcript (Xem/Nghe)</h2>
                
                <div id="audio-player-mock">
                    <span class="play-btn-mock" onclick="toggleFullPlay()">‚ñ∂</span>
                    <span class="time-mock" id="audio-time">0:00 / 0:00</span>
                    <div class="progress-bar-mock">
                        <div class="progress-mock" id="audio-progress"></div>
                    </div>
                    <span class="volume-mock">üîä</span>
                    <span class="volume-mock">‚ãÆ</span>
                </div>
                
                <h3 style="margin-top: 20px;">T·ª´ng C√¢u</h3>
                
                <ul id="transcript-list">
                    <li>Ch∆∞a c√≥ n·ªôi dung b√†i h·ªçc. Vui l√≤ng t·∫°o b√†i m·ªõi ho·∫∑c t·∫£i b√†i c≈©.</li>
                </ul>
                
                <h3 style="margin-top: 30px;">To√†n b·ªô ƒêo·∫°n VƒÉn b·∫£n</h3>
                <div id="full-transcript-text">
                    VƒÉn b·∫£n ƒë·∫ßy ƒë·ªß s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y khi b√†i h·ªçc ƒë∆∞·ª£c t·∫£i.
                </div>
            </div>
        </div>

        <div id="manager" class="tab-content hidden">
            <div class="manager-group">
                <h3>T·∫°o B√†i H·ªçc M·ªõi (Upload Text)</h3>
                <label for="story-title-input">T√™n B√†i H·ªçc M·ªõi:</label>
                <input type="text" id="story-title-input" placeholder="Ch·ª©c nƒÉng n√†y ch·ªâ d√†nh cho ch·ªß ·ª©ng d·ª•ng (Admin)." readonly>
                
                <label for="new-transcript-input">N·ªôi dung B√†i H·ªçc (Full Transcript - D√°n Text v√†o ƒë√¢y):</label>
                <textarea id="new-transcript-input" placeholder="Ch·ª©c nƒÉng n√†y ch·ªâ d√†nh cho ch·ªß ·ª©ng d·ª•ng (Admin)." readonly></textarea>
                
                <button id="save-story-btn">L∆∞u B√†i H·ªçc M·ªõi</button> <p id="save-status" style="margin-top: 10px; font-size: 0.9em; color: red;">ƒê·ªÉ th√™m/s·ª≠a b√†i, vui l√≤ng d√πng phi√™n b·∫£n ri√™ng c·ªßa Admin (ch·ªß ·ª©ng d·ª•ng).</p>
            </div>

            <div class="manager-group">
                <h3>B√†i H·ªçc ƒê√£ L∆∞u (B·∫•m ƒë·ªÉ T·∫£i)</h3>
                <ul id="saved-stories-list">
                    </ul>
            </div>
        </div>

    </div>

    <script>
        // Kh·ªüi t·∫°o c√°c bi·∫øn to√†n c·ª•c
        let currentStoryId = null;
        let sentences = [];
        let rawTranscript = ''; 
        let currentSentenceIndex = 0;
        let isSpeaking = false;
        const speechSynth = window.speechSynthesis;
        let currentUtterance = null;
        let isFullPlaying = false;
        let fullPlayIndex = 0;
        let totalDuration = 0; 
        
        // D·ªØ li·ªáu b√†i h·ªçc m·∫´u ban ƒë·∫ßu
        const defaultStory = {
            id: 'demo_story',
            title: 'The Snow Day',
            transcript: `Today is November 26th.
It snowed all day today.
The snow is beautiful.
The snow finally stopped.
My sister and I are excited.
My mom doesn't like the snow.
My mom has to shovel the driveway.
`,
            notes: ''
        };
        
        // --- CH·ª®C NƒÇNG CHUNG & TTS ---
        
        function openTab(tabName, elmnt) {
            document.querySelectorAll(".tab-content").forEach(el => el.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelectorAll(".tab-button").forEach(el => el.classList.remove("active"));
            elmnt.classList.add("active");
            // D·ª´ng ƒë·ªçc khi chuy·ªÉn tab
            if (isSpeaking) {
                speechSynth.cancel();
                isSpeaking = false;
                isFullPlaying = false;
                // ƒê·∫£m b·∫£o n√∫t play m√¥ ph·ªèng ƒë∆∞·ª£c reset
                const mockPlayBtn = document.querySelector('#audio-player-mock .play-btn-mock');
                if (mockPlayBtn) mockPlayBtn.textContent = '‚ñ∂'; 
                document.querySelectorAll('#transcript-list .sentence-text').forEach(span => span.classList.remove('highlight'));
            }
        }
        
        function speak(text, rate, callback = null) {
            if (isSpeaking) {
                speechSynth.cancel();
            }
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.rate = rate;
            currentUtterance.lang = 'en-GB'; // Gi·ªçng Anh-Anh (UK)
            
            currentUtterance.onstart = () => { isSpeaking = true; };
            currentUtterance.onend = () => { isSpeaking = false; if (callback) callback(); };
            currentUtterance.onerror = (event) => { console.error('Speech synthesis error:', event.error); isSpeaking = false; };

            speechSynth.speak(currentUtterance);
        }

        // --- QU·∫¢N L√ù B√ÄI H·ªåC (MANAGER) ---
        
        function getSavedStories() {
            const stories = JSON.parse(localStorage.getItem('savedStories')) || {};
            if (Object.keys(stories).length === 0) {
                stories[defaultStory.id] = defaultStory;
                localStorage.setItem('savedStories', JSON.stringify(stories));
            }
            return stories;
        }

        function saveStories(stories) {
            localStorage.setItem('savedStories', JSON.stringify(stories));
            renderSavedStories();
        }
        
        // Render saved stories - Lo·∫°i b·ªè n√∫t X√≥a
        function renderSavedStories() {
            const list = document.getElementById('saved-stories-list');
            list.innerHTML = '';
            const stories = getSavedStories();

            Object.values(stories).forEach(story => {
                const li = document.createElement('li');
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'story-name';
                nameSpan.textContent = story.title;
                nameSpan.onclick = () => loadStory(story.id);

                // N√∫t X√ìA (delete-btn) ƒë√£ ƒë∆∞·ª£c ·∫©n qua CSS, nh∆∞ng h√†m n√†y v·∫´n ph·∫£i t·∫°o ra c·∫•u tr√∫c n·∫øu c·∫ßn
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'X√≥a';
                // Ch·ª©c nƒÉng x√≥a ƒë√£ b·ªã lo·∫°i b·ªè/v√¥ hi·ªáu h√≥a trong b·∫£n public
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    alert('Ch·ª©c nƒÉng x√≥a ƒë√£ b·ªã kh√≥a trong phi√™n b·∫£n c√¥ng khai n√†y.');
                };

                li.appendChild(nameSpan);
                li.appendChild(deleteBtn);
                list.appendChild(li);
            });
        }
        
        // V√¥ hi·ªáu h√≥a ch·ª©c nƒÉng L∆∞u B√†i H·ªçc M·ªõi
        document.addEventListener('DOMContentLoaded', () => {
             const saveButton = document.getElementById('save-story-btn');
             if (saveButton) {
                saveButton.onclick = () => {
                    alert('Ch·ª©c nƒÉng t·∫°o/l∆∞u b√†i h·ªçc m·ªõi ƒë√£ b·ªã kh√≥a trong phi√™n b·∫£n c√¥ng khai n√†y.');
                };
             }
        });

        function deleteStory(id) {
            // H√†m n√†y v·∫´n t·ªìn t·∫°i nh∆∞ng kh√¥ng ƒë∆∞·ª£c g·ªçi t·ª´ giao di·ªán public
            const stories = getSavedStories();
            delete stories[id];
            saveStories(stories);
            if (currentStoryId === id) {
                currentStoryId = null;
                resetStudyArea();
            }
        }
        
        // --- LOAD STORY ---
        function loadStory(id) {
            const stories = getSavedStories();
            const story = stories[id];
            if (!story) return;

            currentStoryId = id;
            rawTranscript = story.transcript.trim(); 
            
            // Chia transcript th√†nh c√°c c√¢u
            sentences = rawTranscript.split(/([\.?!])\s*/g).reduce((acc, part, index, array) => {
                if (index % 2 === 0 && part.trim().length > 0) {
                    const fullSentence = part.trim() + (array[index + 1] || '');
                    acc.push(fullSentence.trim());
                }
                return acc;
            }, []);

            currentSentenceIndex = 0;
            
            document.getElementById('current-story-title').textContent = story.title;
            document.getElementById('user-notes').value = story.notes; // L·∫•y ghi ch√∫ c√° nh√¢n
            
            // T√≠nh th·ªùi l∆∞·ª£ng m√¥ ph·ªèng (kho·∫£ng 3 gi√¢y/c√¢u)
            totalDuration = sentences.length * 3; 
            updateMockAudioTime(0, totalDuration);

            renderTranscriptList();
            
            enableStudyButtons();
            updateDictationArea();
            
            // C·∫≠p nh·∫≠t Full Transcript Text
            document.getElementById('full-transcript-text').textContent = rawTranscript;

            openTab('dictiation-page', document.querySelector('.tab-controls button:nth-child(1)'));
        }

        // --- DICTATION PAGE ---
        
        function updateDictationArea() {
            document.getElementById('total-sentences').textContent = sentences.length;
            document.getElementById('current-sentence-index').textContent = currentSentenceIndex + 1;
            document.getElementById('user-input').value = '';
            document.getElementById('feedback-area').innerHTML = ''; 
            
            if (currentSentenceIndex >= sentences.length) {
                alert('Ho√†n th√†nh b√†i Dictiation! B·∫°n ƒë√£ ho√†n th√†nh to√†n b·ªô b√†i h·ªçc n√†y.');
                currentSentenceIndex = 0; 
                updateDictationArea(); 
                return;
            }

            if (sentences.length > 0) {
                document.getElementById('read-sentence-btn').click(); 
                document.getElementById('user-input').focus();
            }
        }

        function navigateNextSentence() {
            currentSentenceIndex++;
            updateDictationArea();
        }

        document.getElementById('read-sentence-btn').onclick = () => {
            if (!sentences[currentSentenceIndex]) return;
            const sentence = sentences[currentSentenceIndex];
            const rate = parseFloat(document.getElementById('speech-rate').value);
            speak(sentence, rate);
        };

        document.getElementById('check-btn').onclick = () => {
            const expectedRaw = sentences[currentSentenceIndex];
            const normalize = (text) => text.replace(/[\.?!,"]/g, '').toLowerCase().trim();
            
            const expected = normalize(expectedRaw).split(/\s+/).filter(w => w.length > 0);
            const actual = normalize(document.getElementById('user-input').value).split(/\s+/).filter(w => w.length > 0);
            const feedbackArea = document.getElementById('feedback-area');
            
            const existingTranslation = feedbackArea.querySelector('.translation') ? feedbackArea.querySelector('.translation').outerHTML : '';
            
            feedbackArea.innerHTML = existingTranslation; 

            let resultHTML = 'K·∫øt qu·∫£: ';
            let isCorrect = true;
            let longestLength = Math.max(expected.length, actual.length);

            for (let i = 0; i < longestLength; i++) {
                const expectedWord = expected[i] || '';
                const actualWord = actual[i] || '';

                if (actualWord === expectedWord && expectedWord !== '') {
                    resultHTML += `<span class="correct">${actualWord}</span> `;
                } else {
                    isCorrect = false;
                    if (actualWord === '') {
                        resultHTML += `<span class="incorrect">[${expectedWord}]</span> `; 
                    } else if (expectedWord === '') {
                        resultHTML += `<span class="incorrect">${actualWord}</span> `; 
                    } else {
                        resultHTML += `<span class="incorrect">${actualWord}</span> `; 
                    }
                }
            }
            
            feedbackArea.innerHTML += resultHTML;
            
            if (isCorrect && actual.length === expected.length) {
                feedbackArea.innerHTML += '<p style="color: green; margin-top: 10px;">Tuy·ªát v·ªùi! C√¢u tr·∫£ l·ªùi ho√†n to√†n ch√≠nh x√°c.</p>';
            } else {
                feedbackArea.innerHTML += '<p style="color: red; margin-top: 10px;">V·∫´n c√≤n l·ªói. H√£y nghe l·∫°i v√† th·ª≠ l·∫ßn n·ªØa.</p>';
            }
        };

        document.getElementById('skip-btn').onclick = () => {
            if (confirm("B·∫°n c√≥ mu·ªën b·ªè qua c√¢u n√†y v√† chuy·ªÉn sang c√¢u ti·∫øp theo kh√¥ng?")) {
                navigateNextSentence();
            }
        };
        
        document.getElementById('next-play-btn').onclick = () => {
            navigateNextSentence();
        };

        function translateSentence() {
            if (!sentences[currentSentenceIndex]) return;
            const sentence = sentences[currentSentenceIndex];
            const feedbackArea = document.getElementById('feedback-area');
            
            const mockTranslation = "D·ªãch: ƒê√¢y l√† b·∫£n d·ªãch m√¥ ph·ªèng c·ªßa c√¢u: " + sentence + " (Ph·∫ßn m·ªÅm th·ª±c t·∫ø c·∫ßn API d·ªãch).";
            
            let content = feedbackArea.innerHTML;
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');
            const oldTranslation = doc.querySelector('.translation');
            
            const newTranslationHTML = `<div class="translation">${mockTranslation}</div>`;
            
            if (oldTranslation) {
                oldTranslation.remove();
                content = doc.body.innerHTML;
            } else {
                content = feedbackArea.innerHTML;
            }
            
            feedbackArea.innerHTML = newTranslationHTML + content;
        }


        // --- FULL TRANSCRIPT PAGE ---

        function renderTranscriptList() {
            const list = document.getElementById('transcript-list');
            list.innerHTML = '';

            if (sentences.length === 0) {
                 list.innerHTML = '<li>Ch∆∞a c√≥ n·ªôi dung b√†i h·ªçc.</li>';
                 return;
            }

            sentences.forEach((sentence, index) => {
                const li = document.createElement('li');
                li.id = `s-${index}`;

                const playBtn = document.createElement('button');
                playBtn.className = 'play-small-btn';
                playBtn.onclick = () => {
                    const rate = parseFloat(document.getElementById('speech-rate').value);
                    speak(sentence, rate);
                    
                    document.querySelectorAll('#transcript-list .sentence-text').forEach(span => span.classList.remove('highlight'));
                    li.querySelector('.sentence-text').classList.add('highlight');
                    
                    currentUtterance.onend = () => {
                        li.querySelector('.sentence-text').classList.remove('highlight');
                    };
                };

                const textSpan = document.createElement('span');
                textSpan.className = 'sentence-text';
                textSpan.textContent = sentence;

                li.appendChild(playBtn);
                li.appendChild(textSpan);
                list.appendChild(li);
            });
        }
        
        function updateMockAudioTime(current, total) {
            const formatTime = (seconds) => {
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${min}:${sec}`;
            };
            document.getElementById('audio-time').textContent = `${formatTime(current)} / ${formatTime(total)}`;
            const progressPercent = (current / total) * 100;
            document.getElementById('audio-progress').style.width = `${progressPercent}%`;
        }

        function toggleFullPlay() {
            if (isFullPlaying) {
                speechSynth.cancel();
                isSpeaking = false;
                isFullPlaying = false;
                document.querySelectorAll('#transcript-list .sentence-text').forEach(span => span.classList.remove('highlight'));
                document.querySelector('#audio-player-mock .play-btn-mock').textContent = '‚ñ∂';
                return;
            }
            
            if (sentences.length === 0) return;
            
            isFullPlaying = true;
            fullPlayIndex = 0;
            document.querySelector('#audio-player-mock .play-btn-mock').textContent = '‚ùö‚ùö';
            
            speakNextSentenceFull();
        }

        function speakNextSentenceFull() {
            if (!isFullPlaying || fullPlayIndex >= sentences.length) {
                isFullPlaying = false;
                document.querySelectorAll('#transcript-list .sentence-text').forEach(span => span.classList.remove('highlight'));
                document.querySelector('#audio-player-mock .play-btn-mock').textContent = '‚ñ∂';
                updateMockAudioTime(totalDuration, totalDuration); 
                return;
            }
            
            const rate = parseFloat(document.getElementById('speech-rate').value);
            
            document.querySelectorAll('#transcript-list .sentence-text').forEach(span => span.classList.remove('highlight'));
            const currentTextSpan = document.querySelector(`#s-${fullPlayIndex} .sentence-text`);
            if (currentTextSpan) {
                currentTextSpan.classList.add('highlight');
                currentTextSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            const currentTime = Math.min(totalDuration, fullPlayIndex * 3); 
            updateMockAudioTime(currentTime, totalDuration);

            const sentence = sentences[fullPlayIndex];
            speak(sentence, rate, () => {
                fullPlayIndex++;
                speakNextSentenceFull(); 
            });
        }

        document.querySelector('#audio-player-mock .play-btn-mock').onclick = toggleFullPlay;


        // --- GHI CH√ö C√Å NH√ÇN & K√çCH HO·∫†T N√öT ---

        function saveNotes() {
            if (!currentStoryId) {
                document.getElementById('note-status').textContent = 'Vui l√≤ng ch·ªçn b√†i h·ªçc tr∆∞·ªõc khi l∆∞u ghi ch√∫.';
                document.getElementById('note-status').style.color = 'red';
                return;
            }
            
            const notes = document.getElementById('user-notes').value;
            const stories = getSavedStories();
            
            if (stories[currentStoryId]) {
                stories[currentStoryId].notes = notes;
                saveStories(stories);
                document.getElementById('note-status').textContent = 'Ghi ch√∫ ƒë√£ ƒë∆∞·ª£c l∆∞u!';
                document.getElementById('note-status').style.color = 'green';
                setTimeout(() => document.getElementById('note-status').textContent = '', 3000);
            }
        }

        function enableStudyButtons() {
             document.getElementById('read-sentence-btn').disabled = false;
             document.getElementById('check-btn').disabled = false;
             document.getElementById('skip-btn').disabled = false;
             document.getElementById('next-play-btn').disabled = false;
             document.getElementById('translate-btn').disabled = false; 
             document.querySelector('#audio-player-mock .play-btn-mock').style.pointerEvents = 'auto'; 
             document.querySelectorAll('.play-small-btn').forEach(btn => btn.disabled = false);
        }

        function resetStudyArea() {
            document.getElementById('current-story-title').textContent = 'Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c ch·ªçn.';
            document.getElementById('transcript-list').innerHTML = '<li>Ch∆∞a c√≥ n·ªôi dung b√†i h·ªçc. Vui l√≤ng t·∫°o b√†i m·ªõi ho·∫∑c t·∫£i b√†i c≈©.</li>';
            document.getElementById('full-transcript-text').textContent = 'VƒÉn b·∫£n ƒë·∫ßy ƒë·ªß s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y khi b√†i h·ªçc ƒë∆∞·ª£c t·∫£i.';
            document.getElementById('user-notes').value = '';
            
            document.getElementById('read-sentence-btn').disabled = true;
            document.getElementById('check-btn').disabled = true;
            document.getElementById('skip-btn').disabled = true;
            document.getElementById('next-play-btn').disabled = true;
            document.getElementById('translate-btn').disabled = true;
            const mockPlayBtn = document.querySelector('#audio-player-mock .play-btn-mock');
            if (mockPlayBtn) mockPlayBtn.style.pointerEvents = 'none';

            document.getElementById('total-sentences').textContent = 0;
            document.getElementById('current-sentence-index').textContent = 0;
            document.getElementById('user-input').value = '';
            document.getElementById('feedback-area').innerHTML = '';
            updateMockAudioTime(0, 0);
        }

        // --- KH·ªûI T·∫†O BAN ƒê·∫¶U ---
        
        document.addEventListener('DOMContentLoaded', () => {
            renderSavedStories(); // V·∫´n ch·∫°y ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch b√†i h·ªçc
            loadStory(defaultStory.id); 
        });
        
        const rateSlider = document.getElementById('speech-rate');
        const rateDisplay = document.getElementById('rate-display');
        rateSlider.oninput = () => {
            rateDisplay.textContent = `${rateSlider.value}x`;
        };
    </script>
</body>
</html>
