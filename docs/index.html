<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Practice English with Hachin</title>
    <style>
        /* CSS D√ÄNH CHO GIAO DI·ªÜN CHUNG V√Ä C√ÅC TH√ÄNH PH·∫¶N */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; margin-bottom: 25px; } 
        
        /* Tab Controls */
        .tab-controls { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-button { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; transition: all 0.3s; color: #555; font-weight: 600; border-radius: 8px 8px 0 0; }
        .tab-button:hover { background-color: #e9ecef; }
        .tab-button.active { background-color: #007bff; color: white; border-radius: 8px 8px 0 0; }
        .tab-content { padding: 15px 0; }
        .tab-content.hidden { display: none; }

        /* Controls Area */
        #controls-area { padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; background-color: #f8f9fa; }
        
        /* CH·ªàNH S·ª¨A TI√äU ƒê·ªÄ B√ÄI H·ªåC */
        #current-story-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        #edit-story-btn { 
            display: none; 
            padding: 5px 10px; 
            background-color: #ffc107; 
            color: #333; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 10px;
        }

        /* Dictation & Controls */
        #user-input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .dictation-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .dictation-controls button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        #read-sentence-btn { background: none; border: none; cursor: pointer; font-size: 30px; color: #28a745; padding: 0; margin-right: 15px; transition: color 0.2s; }
        #feedback-area { margin-top: 15px; padding: 15px; border-radius: 6px; min-height: 50px; background-color: #e9ecef; }
        .correct { color: #28a745; font-weight: bold; }
        .incorrect { color: #dc3545; font-weight: bold; text-decoration: underline; }

        /* Transcript */
        #transcript-list { list-style: none; padding: 0; }
        #full-transcript-text { white-space: pre-wrap; font-size: 1.1em; line-height: 1.6; }
        .play-small-btn { background-color: #e6f0ff; border: 1px solid #007bff; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #007bff; font-size: 14px; padding-left: 3px; margin-right: 10px; }
        #transcript-list li { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 1.1em; }
        .highlight { background-color: #fff3cd; padding: 2px 4px; border-radius: 3px; }
        
        /* Notes & Manager */
        #user-notes { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; resize: vertical; font-size: 14px; }
        .manager-group { margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        
        /* ADMIN AUTH */
        #admin-auth { text-align: right; margin-bottom: 10px; display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        #admin-auth input { border: 1px solid #ccc; padding: 5px; width: 150px; }
        #admin-auth button { border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        #auth-btn { background-color: #007bff; color: white; }
        #toggle-admin-btn { background-color: #6c757d; color: white; display: none; }
        
        /* ·∫®n c√°c th√†nh ph·∫ßn Admin (s·∫Ω ƒë∆∞·ª£c JS m·ªü) */
        .admin-only { display: none; }

        /* AUDIO MOCK */
        #audio-player-mock { 
            display: flex; align-items: center; background: #e0e0e0; padding: 10px; border-radius: 8px; margin-bottom: 15px;
            opacity: 0.7; 
        }
        .play-btn-mock { font-size: 24px; cursor: pointer; margin-right: 10px; color: #007bff; }
        .time-mock { font-size: 14px; margin-right: 10px; }
        .progress-bar-mock { flex-grow: 1; height: 8px; background: #ccc; border-radius: 4px; overflow: hidden; }
        .progress-mock { height: 100%; width: 0%; background: #28a745; transition: width 0.1s linear; }
        .volume-mock { margin-left: 10px; font-size: 16px; }

    </style>
</head>
<body>
    <div class="container">
        <h1 id="main-title">Practice English with Hachin</h1>

        <div id="admin-auth">
            <input type="password" id="admin-password" placeholder="M·∫≠t kh·∫©u Admin">
            <button id="auth-btn" onclick="checkAdminPassword()">ƒêƒÉng nh·∫≠p Admin</button>
            <button id="toggle-admin-btn" onclick="toggleAdminMode()"></button>
            <span id="auth-status" style="margin-left: 10px; font-size: 0.9em;"></span>
        </div>

        <div class="tab-controls">
            <button class="tab-button active" onclick="openTab('dictiation-page', this)">Dictiation</button>
            <button class="tab-button" onclick="openTab('transcript-page', this)">Full Transcript</button>
            <button class="tab-button" onclick="openTab('manager', this)">B√†i h·ªçc</button> 
        </div>

        <div id="controls-area">
            <div id="current-story-container">
                <p style="margin: 0;">B√†i h·ªçc ƒëang m·ªü: <strong id="current-story-title">Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c ch·ªçn.</strong></p>
                <button id="edit-story-btn" onclick="prepareToEditStory()">S·ª≠a B√†i H·ªçc N√†y</button>
            </div>
            
            <div class="speed-control control-group">
                <label for="speech-rate">T·ªëc ƒë·ªô ƒë·ªçc:</label>
                <input type="range" id="speech-rate" min="0.5" max="2" step="0.1" value="1.0">
                <span id="rate-display">1.0x</span>
            </div>
        </div>

        <div id="dictiation-page" class="tab-content">
            <div id="dictiation-content">
                <p>C√¢u hi·ªán t·∫°i: <span id="current-sentence-index">0</span> / <span id="total-sentences">0</span></p>
                
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <button id="read-sentence-btn" disabled>‚ñ∂</button>
                    <span style="font-size: 1.1em; font-weight: 500;">Nghe c√¢u</span>
                </div>
                
                <input type="text" id="user-input" placeholder="G√µ l·∫°i nh·ªØng g√¨ b·∫°n nghe...">
                
                <div class="dictation-controls">
                    <button id="check-btn" disabled>Check</button>
                    <button id="skip-btn" disabled>Skip</button>
                    <button id="next-play-btn" disabled>Next & Play</button>
                    <button id="translate-btn" disabled onclick="translateSentence()">D·ªãch C√¢u</button>
                </div>
                
                <div id="feedback-area"></div>
                
                <div id="notes-area">
                    <h3>√î Ghi Ch√∫ C√° Nh√¢n</h3>
                    <textarea id="user-notes" placeholder="Ghi ch√∫ t·ª´ v·ª±ng, ng·ªØ ph√°p, hay b·∫•t c·ª© ƒëi·ªÅu g√¨ b·∫°n mu·ªën l∆∞u l·∫°i v·ªÅ b√†i h·ªçc n√†y..."></textarea>
                    <button onclick="saveNotes()" style="margin-top: 10px; padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 5px;">L∆∞u Ghi Ch√∫</button>
                    <p id="note-status" style="margin-top: 5px; font-size: 0.9em; color: green;"></p>
                </div>
            </div>
        </div>

        <div id="transcript-page" class="tab-content hidden">
             <div id="transcript-content">
                <h2>Full Transcript (Xem/Nghe)</h2>
                
                <div id="audio-player-mock">
                    <span class="play-btn-mock" onclick="toggleFullPlay()">‚ñ∂</span>
                    <span class="time-mock" id="audio-time">0:00 / 0:00</span>
                    <div class="progress-bar-mock">
                        <div class="progress-mock" id="audio-progress"></div>
                    </div>
                    <span class="volume-mock">üîä</span>
                </div>
                
                <h3 style="margin-top: 20px;">T·ª´ng C√¢u</h3>
                
                <ul id="transcript-list">
                    <li>Ch∆∞a c√≥ n·ªôi dung b√†i h·ªçc. Vui l√≤ng t·∫£i b√†i h·ªçc.</li>
                </ul>
                
                <h3 style="margin-top: 30px;">To√†n b·ªô ƒêo·∫°n VƒÉn b·∫£n</h3>
                <div id="full-transcript-text">
                    VƒÉn b·∫£n ƒë·∫ßy ƒë·ªß s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y khi b√†i h·ªçc ƒë∆∞·ª£c t·∫£i.
                </div>
            </div>
        </div>

        <div id="manager" class="tab-content hidden">
            
            <div class="manager-group admin-only" id="create-lesson-group">
                <h3 id="lesson-management-title">T·∫°o B√†i H·ªçc M·ªõi</h3>
                <button onclick="resetLessonForm()" style="background-color: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-bottom: 15px; cursor: pointer;">
                    + T·∫°o B√†i H·ªçc M·ªõi (Reset Form)
                </button>
                <label for="story-title-input">T√™n B√†i H·ªçc:</label>
                <input type="text" id="story-title-input" placeholder="V√≠ d·ª•: My New Lesson">
                
                <label for="new-transcript-input">N·ªôi dung B√†i H·ªçc (Full Transcript):</label>
                <textarea id="new-transcript-input" placeholder="D√°n vƒÉn b·∫£n ti·∫øng Anh v√†o ƒë√¢y. M·ªói d√≤ng xu·ªëng d√≤ng ho·∫∑c d·∫•u ch·∫•m c√¢u s·∫Ω l√† m·ªôt c√¢u dictation."></textarea>
                
                <button id="save-story-btn" onclick="saveNewOrEditedStory()" style="background-color: #007bff; color: white; border: none; padding: 10px; border-radius: 5px; margin-top: 10px;">L∆∞u B√†i H·ªçc</button>
                <button id="export-btn" onclick="exportData()" style="background-color: #28a745; color: white; border: none; padding: 10px; border-radius: 5px; margin-top: 10px;">Xu·∫•t D·ªØ Li·ªáu CODE (ƒê·ªÉ chia s·∫ª)</button>
                <p id="save-status" style="margin-top: 10px; font-size: 0.9em;"></p>
            </div>

            <div id="admin-warning" style="display: none; padding: 15px; border: 1px solid #dc3545; background-color: #f8d7da; color: #721c24; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0;">B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô **Ng∆∞·ªùi d√πng**. Ch·ª©c nƒÉng T·∫°o/S·ª≠a/X√≥a b√†i h·ªçc ƒë√£ b·ªã kh√≥a.</p>
            </div>

            <div class="manager-group">
                <h3>B√†i H·ªçc ƒê√£ L∆∞u (B·∫•m ƒë·ªÉ T·∫£i)</h3>
                <ul id="saved-stories-list">
                    </ul>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // C√ÄI ƒê·∫∂T
        // =================================================================
        const ADMIN_PASSWORD = "Hachin@1306"; 
        let IS_ADMIN_MODE = false;
        let storyToEditId = null; 
        
        // =================================================================
        // D·ªÆ LI·ªÜU B√ÄI H·ªåC BAN ƒê·∫¶U (D·ªÆ LI·ªÜU C√îNG KHAI)
        // =================================================================
        const initialStories = {
            "story_snow_day": {
                id: 'story_snow_day',
                title: 'The Snow Day (B√†i h·ªçc m·∫´u)',
                transcript: `Today is November 26th.
It snowed all day today.
The snow is beautiful.
The snow finally stopped.
My sister and I are excited.
My mom doesn't like the snow.
My mom has to shovel the driveway.
`,
                notes: ''
            },
            "story_gym": {
                id: 'story_gym',
                title: 'ƒêI T·∫¨P GYM',
                transcript: `I need to wake up early for the gym.
It is important to stretch before exercising.
I do bench presses and squats.
After my workout, I drink a protein shake.
I feel great and ready for the day.
`,
                notes: ''
            }
        };
        // =================================================================
        
        // C√ÅC BI·∫æN CHUNG
        let currentStoryId = null;
        let sentences = [];
        let rawTranscript = ''; 
        let currentSentenceIndex = 0;
        let isSpeaking = false;
        const speechSynth = window.speechSynthesis;
        let currentUtterance = null;
        let isFullPlaying = false;
        let fullPlayIndex = 0;
        let totalDuration = 0; 
        
        // =================================================================
        // CH·ª®C NƒÇNG X√ÅC TH·ª∞C ADMIN
        // =================================================================
        
        function checkAdminPassword() {
            const passwordInput = document.getElementById('admin-password');
            const status = document.getElementById('auth-status');
            
            if (passwordInput.value === ADMIN_PASSWORD) {
                IS_ADMIN_MODE = true;
                localStorage.setItem('isAdmin', 'true'); 
                status.textContent = 'ƒêƒÉng nh·∫≠p Admin th√†nh c√¥ng!';
                status.style.color = 'green';
                passwordInput.value = '';
                updateAdminModeUI();
                // Chuy·ªÉn th·∫≥ng v·ªÅ ch·∫ø ƒë·ªô t·∫°o b√†i m·ªõi sau khi ƒëƒÉng nh·∫≠p 
                resetLessonForm(); 
            } else {
                IS_ADMIN_MODE = false;
                localStorage.setItem('isAdmin', 'false');
                status.textContent = 'M·∫≠t kh·∫©u sai!';
                status.style.color = 'red';
            }
        }
        
        function toggleAdminMode() {
            if (isSpeaking) { speechSynth.cancel(); isSpeaking = false; }
            if (IS_ADMIN_MODE) {
                // Chuy·ªÉn sang ch·∫ø ƒë·ªô Kh√°ch
                IS_ADMIN_MODE = false;
                localStorage.setItem('isAdmin', 'false');
                document.getElementById('auth-status').textContent = 'ƒê√£ ƒëƒÉng xu·∫•t.';
            } else {
                // Chuy·ªÉn sang ch·∫ø ƒë·ªô Admin (hi·ªán √¥ ƒëƒÉng nh·∫≠p)
                document.getElementById('admin-password').style.display = 'inline-block';
                document.getElementById('auth-btn').style.display = 'inline-block';
                document.getElementById('auth-status').textContent = '';
            }
            updateAdminModeUI();
        }

        function updateAdminModeUI() {
            const adminElements = document.querySelectorAll('.admin-only');
            const mainTitle = document.getElementById('main-title');
            const adminWarning = document.getElementById('admin-warning');
            const authInput = document.getElementById('admin-password');
            const authBtn = document.getElementById('auth-btn');
            const toggleBtn = document.getElementById('toggle-admin-btn');
            const editBtn = document.getElementById('edit-story-btn');

            if (IS_ADMIN_MODE) {
                // Hi·ªÉn th·ªã t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ admin
                adminElements.forEach(el => el.style.display = 'block');
                mainTitle.style.color = '#dc3545'; 
                mainTitle.textContent = 'Practice English with Hachin - ADMIN';
                authInput.style.display = 'none';
                authBtn.style.display = 'none';
                toggleBtn.style.display = 'inline-block';
                toggleBtn.textContent = 'Ch·∫ø ƒë·ªô Kh√°ch';
                adminWarning.style.display = 'none';
                // ƒê·∫£m b·∫£o n√∫t edit hi·ªÉn th·ªã n·∫øu c√≥ b√†i ƒëang load
                if (currentStoryId) editBtn.style.display = 'inline-block'; 
            } else {
                // ·∫®n t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ admin
                adminElements.forEach(el => el.style.display = 'none');
                mainTitle.style.color = '#007bff'; 
                mainTitle.textContent = 'Practice English with Hachin';
                
                // Qu·∫£n l√Ω tr·∫°ng th√°i n√∫t ƒëƒÉng nh·∫≠p/chuy·ªÉn ƒë·ªïi
                if (localStorage.getItem('isAdmin') === 'true') { 
                    authInput.style.display = 'none';
                    authBtn.style.display = 'none';
                    toggleBtn.style.display = 'inline-block';
                    toggleBtn.textContent = 'ƒêƒÉng nh·∫≠p Admin';
                } else {
                    authInput.style.display = 'inline-block';
                    authBtn.style.display = 'inline-block';
                    toggleBtn.style.display = 'none';
                }
                
                editBtn.style.display = 'none';
                
                if (document.getElementById('manager').classList.contains('hidden') === false) {
                    adminWarning.style.display = 'block';
                }
            }
            renderSavedStories(); 
        }

        // =================================================================
        // H√ÄM QU·∫¢N L√ù D·ªÆ LI·ªÜU
        // =================================================================

        function getSavedStoriesFinal() {
            const storiesInStorage = JSON.parse(localStorage.getItem('savedStories')) || {};
            let finalStories = { ...initialStories }; 
            
            for (const key in storiesInStorage) {
                // H·ª£p nh·∫•t d·ªØ li·ªáu: B√†i m·ªõi c·ªßa admin ƒë∆∞·ª£c th√™m v√†o, notes c·ªßa user ƒë∆∞·ª£c gi·ªØ l·∫°i
                finalStories[key] = { ...finalStories[key] || {}, ...storiesInStorage[key] };
            }
            
            // C·∫≠p nh·∫≠t l·∫°i LocalStorage ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô
            localStorage.setItem('savedStories', JSON.stringify(finalStories));
            
            return finalStories;
        }
        
        function saveStories(stories) {
            localStorage.setItem('savedStories', JSON.stringify(stories));
            renderSavedStories();
        }

        function renderSavedStories() {
            const list = document.getElementById('saved-stories-list');
            list.innerHTML = '';
            const stories = getSavedStoriesFinal();

            Object.values(stories).forEach(story => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.padding = '5px 0'; // Th√™m padding cho d·ªÖ b·∫•m

                const nameSpan = document.createElement('span');
                nameSpan.className = 'story-name';
                nameSpan.textContent = story.title;
                nameSpan.style.cursor = 'pointer';
                nameSpan.style.color = '#007bff';
                nameSpan.onclick = () => loadStory(story.id);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'X√≥a';
                deleteBtn.style.marginLeft = '10px';
                deleteBtn.style.backgroundColor = '#dc3545';
                deleteBtn.style.color = 'white';
                deleteBtn.style.border = 'none';
                deleteBtn.style.padding = '3px 8px';
                deleteBtn.style.borderRadius = '3px';

                // FIX L·ªñI X√ìA B√ÄI H·ªåC ·ªû ƒê√ÇY
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); // NgƒÉn s·ª± ki·ªán click lan truy·ªÅn ƒë·∫øn li (loadStory)
                    if (!IS_ADMIN_MODE) { alert('Ch·ª©c nƒÉng x√≥a ch·ªâ d√†nh cho Admin.'); return; }
                    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i h·ªçc "${story.title}" kh·ªèi b·ªô nh·ªõ c·ª•c b·ªô kh√¥ng?`)) {
                        deleteStory(story.id);
                    }
                };
                
                li.appendChild(nameSpan);
                
                // Ch·ªâ hi·ªÉn th·ªã n√∫t x√≥a cho Admin
                if (IS_ADMIN_MODE) {
                    li.appendChild(deleteBtn);
                }
                
                list.appendChild(li);
            });
        }
        
        function deleteStory(id) {
            if (!IS_ADMIN_MODE) { alert('Ch·ª©c nƒÉng x√≥a ch·ªâ d√†nh cho Admin.'); return; } 
            
            const stories = getSavedStoriesFinal();
            
            // N·∫øu b√†i ƒëang c·ªë g·∫Øng x√≥a l√† b√†i m·∫´u, th√¨ ch·ªâ x√≥a kh·ªèi localStorage 
            // ch·ª© kh√¥ng x√≥a kh·ªèi initialStories (v√¨ initialStories l√† data g·ªëc)
            const isInitialStory = initialStories.hasOwnProperty(id);
            
            if (stories[id]) {
                delete stories[id];
                
                // C·∫≠p nh·∫≠t l·∫°i localStorage
                localStorage.setItem('savedStories', JSON.stringify(stories));

                if (currentStoryId === id) { currentStoryId = null; resetStudyArea(); }
                document.getElementById('save-status').textContent = `ƒê√£ x√≥a b√†i h·ªçc ID: ${id}.`;
                document.getElementById('save-status').style.color = 'red';
                
                // T·∫£i l·∫°i danh s√°ch ƒë·ªÉ UI c·∫≠p nh·∫≠t
                renderSavedStories();
                resetLessonForm();
            } else {
                document.getElementById('save-status').textContent = `Kh√¥ng t√¨m th·∫•y b√†i h·ªçc ID: ${id}.`;
                document.getElementById('save-status').style.color = 'orange';
            }
        }
        
        function prepareToEditStory() {
            if (!IS_ADMIN_MODE) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p Admin ƒë·ªÉ s·ª≠a b√†i h·ªçc.');
                return;
            }
            if (!currentStoryId) {
                alert('Vui l√≤ng t·∫£i m·ªôt b√†i h·ªçc tr∆∞·ªõc khi s·ª≠a.');
                return;
            }

            const stories = getSavedStoriesFinal();
            const story = stories[currentStoryId];
            
            if (!story) return;

            // Chuy·ªÉn ƒë·∫øn tab Manager v√† ƒë·∫£m b·∫£o c√°c ph·∫ßn Admin ƒë∆∞·ª£c hi·ªÉn th·ªã
            openTab('manager', document.querySelector('.tab-controls button:nth-child(3)'));
            updateAdminModeUI(); 
            
            // C·∫≠p nh·∫≠t form
            storyToEditId = currentStoryId;
            document.getElementById('lesson-management-title').textContent = 'S·ª≠a B√†i H·ªçc Hi·ªán T·∫°i';
            document.getElementById('story-title-input').value = story.title;
            document.getElementById('new-transcript-input').value = story.transcript;
            document.getElementById('save-story-btn').textContent = 'L∆∞u B√†i H·ªçc ƒê√£ S·ª≠a';
            document.getElementById('save-status').textContent = 'ƒêang s·ª≠a b√†i: ' + story.title;
            document.getElementById('save-status').style.color = 'orange';
            document.getElementById('story-title-input').focus();
        }

        function resetLessonForm() {
            if (!IS_ADMIN_MODE) { alert('Ch·ª©c nƒÉng n√†y ch·ªâ d√†nh cho Admin.'); return; }
            storyToEditId = null;
            document.getElementById('lesson-management-title').textContent = 'T·∫°o B√†i H·ªçc M·ªõi';
            document.getElementById('story-title-input').value = '';
            document.getElementById('new-transcript-input').value = '';
            document.getElementById('save-story-btn').textContent = 'L∆∞u B√†i H·ªçc';
            document.getElementById('save-status').textContent = 'S·∫µn s√†ng t·∫°o b√†i h·ªçc m·ªõi.';
            document.getElementById('save-status').style.color = '#333';
            document.getElementById('story-title-input').focus();
        }

        function saveNewOrEditedStory() {
            if (!IS_ADMIN_MODE) { alert('B·∫°n kh√¥ng c√≥ quy·ªÅn Admin ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y.'); return; }
            const title = document.getElementById('story-title-input').value.trim();
            const transcript = document.getElementById('new-transcript-input').value.trim();

            if (!title || !transcript) {
                document.getElementById('save-status').textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·ªß T√™n v√† N·ªôi dung b√†i h·ªçc.';
                document.getElementById('save-status').style.color = 'red';
                return;
            }

            const stories = getSavedStoriesFinal();
            let storyId;

            if (storyToEditId) {
                storyId = storyToEditId;
                stories[storyId].title = title;
                stories[storyId].transcript = transcript;
                document.getElementById('save-status').textContent = `ƒê√£ c·∫≠p nh·∫≠t b√†i h·ªçc: ${title}!`;
            } else {
                storyId = 's_' + title.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 30) + '_' + Date.now().toString().slice(-4);
                stories[storyId] = { id: storyId, title: title, transcript: transcript, notes: '' };
                document.getElementById('save-status').textContent = `ƒê√£ l∆∞u b√†i h·ªçc m·ªõi: ${title}!`;
            }
            
            saveStories(stories);
            document.getElementById('save-status').style.color = 'green';
            
            // T·∫£i b√†i v·ª´a t·∫°o/s·ª≠a
            loadStory(storyId); 
            
            // Reset form sau khi l∆∞u th√†nh c√¥ng b√†i m·ªõi (n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô t·∫°o m·ªõi)
            if (!storyToEditId) {
                resetLessonForm();
            } else {
                storyToEditId = null; 
            }
        }
        
        function exportData() {
            if (!IS_ADMIN_MODE) { alert('Ch·ª©c nƒÉng n√†y ch·ªâ d√†nh cho Admin.'); return; }
            const stories = getSavedStoriesFinal();
            
            const exportableStories = {};
            for (const key in stories) {
                // Ch·ªâ xu·∫•t c√°c thu·ªôc t√≠nh c·∫ßn thi·∫øt, v√† x·ª≠ l√Ω k√Ω t·ª± xu·ªëng d√≤ng
                exportableStories[key] = {
                    id: stories[key].id,
                    title: stories[key].title,
                    transcript: stories[key].transcript.replace(/\n/g, '\\n'),
                    notes: '' 
                };
            }
            
            const jsonString = JSON.stringify(exportableStories, null, 4);
            
            const codeOutput = `
// =================================================================
// D·ªÆ LI·ªÜU B√ÄI H·ªåC ƒê√É XU·∫§T (D√ÅN KH·ªêI N√ÄY THAY TH·∫æ KH·ªêI initialStories G·ªêC)
// =================================================================
const initialStories = ${jsonString.replace(/\\\\n/g, '\\n')};
// =================================================================
// H·∫æT D·ªÆ LI·ªÜU B√ÄI H·ªåC ƒê√É XU·∫§T
// =================================================================
            `;

            navigator.clipboard.writeText(codeOutput).then(() => {
                alert("ƒê√£ COPY d·ªØ li·ªáu b√†i h·ªçc v√†o clipboard. B·∫°n h√£y D√ÅN (PASTE) kh·ªëi m√£ n√†y thay th·∫ø cho kh·ªëi 'initialStories' trong file CODE n√†y ƒë·ªÉ c·∫≠p nh·∫≠t b·∫£n chia s·∫ª!");
            }).catch(err => {
                console.error('Kh√¥ng th·ªÉ copy m√£: ', err);
                prompt("Sao ch√©p th·ªß c√¥ng kh·ªëi d·ªØ li·ªáu sau:", codeOutput);
            });
        }
        
        // =================================================================
        // H√ÄM X·ª¨ L√ù DICTATION
        // =================================================================

        function loadStory(id) {
            const stories = getSavedStoriesFinal();
            const story = stories[id];
            if (!story) return;
            
            if (isSpeaking) { speechSynth.cancel(); isSpeaking = false; }

            currentStoryId = id;
            rawTranscript = story.transcript.trim(); 
            
            sentences = rawTranscript.split(/([\.?!])\s*/g).reduce((acc, part, index, array) => {
                if (index % 2 === 0 && part.trim().length > 0) {
                    const fullSentence = part.trim() + (array[index + 1] || '');
                    acc.push(fullSentence.trim());
                }
                return acc;
            }, []).filter(s => s.length > 0); 

            currentSentenceIndex = 0;
            
            document.getElementById('current-story-title').textContent = story.title;
            document.getElementById('user-notes').value = story.notes; 
            
            totalDuration = sentences.length * 3; 
            updateMockAudioTime(0, totalDuration);

            renderTranscriptList();
            
            enableStudyButtons();
            updateDictationArea();
            
            document.getElementById('full-transcript-text').textContent = rawTranscript;

            const editBtn = document.getElementById('edit-story-btn');
            // ƒê·∫£m b·∫£o n√∫t S·ª≠a B√†i H·ªçc ƒë∆∞·ª£c hi·ªÉn th·ªã n·∫øu Admin ƒë√£ ƒëƒÉng nh·∫≠p
            if (IS_ADMIN_MODE) { editBtn.style.display = 'inline-block'; } else { editBtn.style.display = 'none'; }
            
            openTab('dictiation-page', document.querySelector('.tab-controls button:nth-child(1)'));
        }

        function updateDictationArea() {
            document.getElementById('total-sentences').textContent = sentences.length;
            document.getElementById('current-sentence-index').textContent = currentSentenceIndex + 1;
            document.getElementById('user-input').value = '';
            document.getElementById('feedback-area').innerHTML = ''; 
            
            if (sentences.length === 0) return;

            if (currentSentenceIndex >= sentences.length) {
                alert('Ho√†n th√†nh b√†i Dictiation!');
                currentSentenceIndex = 0; 
                return;
            }

            if (sentences.length > 0) {
                // T·ª± ƒë·ªông play sau khi chuy·ªÉn c√¢u
                document.getElementById('read-sentence-btn').click(); 
                document.getElementById('user-input').focus();
            }
        }
        
        document.getElementById('read-sentence-btn').onclick = () => {
            if (!sentences[currentSentenceIndex]) return;
            const sentence = sentences[currentSentenceIndex];
            const rate = parseFloat(document.getElementById('speech-rate').value);
            speak(sentence, rate);
        };
        
        document.getElementById('check-btn').onclick = () => { 
             if (!sentences[currentSentenceIndex]) return;
             
             const expectedRaw = sentences[currentSentenceIndex];
             const normalize = (text) => text.replace(/[\.?!,"]/g, '').toLowerCase().trim();
             const expected = normalize(expectedRaw).split(/\s+/).filter(w => w.length > 0);
             const actual = normalize(document.getElementById('user-input').value).split(/\s+/).filter(w => w.length > 0);
             const feedbackArea = document.getElementById('feedback-area');
             
             feedbackArea.innerHTML = ''; 
             let resultHTML = 'K·∫øt qu·∫£: ';
             let isCorrect = true;
             let longestLength = Math.max(expected.length, actual.length);

             for (let i = 0; i < longestLength; i++) {
                 const expectedWord = expected[i] || '';
                 const actualWord = actual[i] || '';

                 if (actualWord === expectedWord && expectedWord !== '') {
                     resultHTML += `<span class="correct">${actualWord}</span> `;
                 } else {
                     isCorrect = false;
                     const displayWord = actualWord === '' ? `[${expectedWord}]` : actualWord;
                     resultHTML += `<span class="incorrect">${displayWord}</span> `; 
                 }
             }
             
             feedbackArea.innerHTML += resultHTML;
             
             if (isCorrect && actual.length === expected.length) {
                 feedbackArea.innerHTML += '<p style="color: green; margin-top: 10px;">Tuy·ªát v·ªùi! C√¢u tr·∫£ l·ªùi ho√†n to√†n ch√≠nh x√°c.</p>';
             } else {
                 feedbackArea.innerHTML += '<p style="color: red; margin-top: 10px;">V·∫´n c√≤n l·ªói. H√£y nghe l·∫°i v√† th·ª≠ l·∫ßn n·ªØa.</p>';
             }
        };
        
        function navigateNextSentence() { 
            currentSentenceIndex++; 
            updateDictationArea(); 
        }
        
        document.getElementById('skip-btn').onclick = () => { if (confirm("B·∫°n c√≥ mu·ªën b·ªè qua c√¢u n√†y v√† chuy·ªÉn sang c√¢u ti·∫øp theo kh√¥ng?")) { navigateNextSentence(); } };
        document.getElementById('next-play-btn').onclick = () => { navigateNextSentence(); };
        
        // =================================================================
        // C√ÅC H√ÄM PH·ª§ TR·ª¢ (M√¥ ph·ªèng & ƒêi·ªÅu khi·ªÉn)
        // =================================================================
        
        function openTab(tabName, elmnt) {
            if (isSpeaking) { speechSynth.cancel(); isSpeaking = false; }
            document.querySelectorAll(".tab-content").forEach(el => el.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelectorAll(".tab-button").forEach(el => el.classList.remove("active"));
            elmnt.classList.add("active");
            
            const adminWarning = document.getElementById('admin-warning');
            if (tabName === 'manager' && !IS_ADMIN_MODE) {
                adminWarning.style.display = 'block';
            } else {
                adminWarning.style.display = 'none';
            }
        }
        
        function speak(text, rate, callback = null) {
            if (isSpeaking) { speechSynth.cancel(); }
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.rate = rate;
            currentUtterance.lang = 'en-GB'; 
            currentUtterance.onstart = () => { isSpeaking = true; };
            currentUtterance.onend = () => { isSpeaking = false; if (callback) callback(); };
            currentUtterance.onerror = (event) => { isSpeaking = false; console.error('Speech synthesis error:', event.error); };
            speechSynth.speak(currentUtterance);
        }
        
        function renderTranscriptList() {
            const list = document.getElementById('transcript-list');
            list.innerHTML = '';

            if (sentences.length === 0) { list.innerHTML = '<li>Ch∆∞a c√≥ n·ªôi dung b√†i h·ªçc.</li>'; return; }

            sentences.forEach((sentence, index) => {
                const li = document.createElement('li');
                li.id = `s-${index}`;

                const playBtn = document.createElement('button');
                playBtn.className = 'play-small-btn';
                playBtn.innerHTML = '‚ñ∂';
                playBtn.onclick = () => {
                    const rate = parseFloat(document.getElementById('speech-rate').value);
                    speak(sentence, rate);
                };

                const textSpan = document.createElement('span');
                textSpan.className = 'sentence-text';
                textSpan.textContent = sentence;

                li.appendChild(playBtn);
                li.appendChild(textSpan);
                list.appendChild(li);
            });
        }
        
        function enableStudyButtons() {
             document.getElementById('read-sentence-btn').disabled = false;
             document.getElementById('check-btn').disabled = false;
             document.getElementById('skip-btn').disabled = false;
             document.getElementById('next-play-btn').disabled = false;
             document.getElementById('translate-btn').disabled = false; 
        }

        function resetStudyArea() {
            document.getElementById('current-story-title').textContent = 'Ch∆∞a c√≥ b√†i n√†o ƒë∆∞·ª£c ch·ªçn.';
            document.getElementById('transcript-list').innerHTML = '<li>Ch∆∞a c√≥ n·ªôi dung b√†i h·ªçc. Vui l√≤ng t·∫£i b√†i h·ªçc.</li>';
            document.getElementById('full-transcript-text').textContent = 'VƒÉn b·∫£n ƒë·∫ßy ƒë·ªß s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y khi b√†i h·ªçc ƒë∆∞·ª£c t·∫£i.';
            document.getElementById('user-notes').value = '';
            
            document.getElementById('read-sentence-btn').disabled = true;
            document.getElementById('check-btn').disabled = true;
            document.getElementById('skip-btn').disabled = true;
            document.getElementById('next-play-btn').disabled = true;
            document.getElementById('translate-btn').disabled = true;

            document.getElementById('total-sentences').textContent = 0;
            document.getElementById('current-sentence-index').textContent = 0;
            document.getElementById('user-input').value = '';
            document.getElementById('feedback-area').innerHTML = '';
            
            document.getElementById('edit-story-btn').style.display = 'none';
        }
        
        function updateMockAudioTime(current, total) { 
            // Mock function 
        }
        function toggleFullPlay() { 
            // Mock function 
        }
        function saveNotes() { 
            const stories = getSavedStoriesFinal();
            if (currentStoryId && stories[currentStoryId]) {
                 stories[currentStoryId].notes = document.getElementById('user-notes').value;
                 localStorage.setItem('savedStories', JSON.stringify(stories));
                 document.getElementById('note-status').textContent = 'ƒê√£ l∆∞u ghi ch√∫!';
            }
        }
        function translateSentence() { 
            if (!sentences[currentSentenceIndex]) return;
            const sentence = sentences[currentSentenceIndex];
            const feedbackArea = document.getElementById('feedback-area');
            
            const mockTranslation = "D·ªãch: ƒê√¢y l√† b·∫£n d·ªãch m√¥ ph·ªèng c·ªßa c√¢u: " + sentence + " (Ch·ª©c nƒÉng d·ªãch c·∫ßn API b√™n ngo√†i).";
            
            let content = feedbackArea.innerHTML;
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');
            const oldTranslation = doc.querySelector('.translation');
            
            if (oldTranslation) oldTranslation.remove(); 

            const newTranslationHTML = `<div class="translation" style="background-color: #fff3cd; color: #333; margin-top: 10px; padding: 8px; border-radius: 4px; font-style: italic;">${mockTranslation}</div>`;
            feedbackArea.innerHTML += newTranslationHTML;
        }


        // =================================================================
        // KH·ªûI T·∫†O
        // =================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Ki·ªÉm tra tr·∫°ng th√°i admin ƒë√£ l∆∞u
            if (localStorage.getItem('isAdmin') === 'true' && ADMIN_PASSWORD !== "") {
                 IS_ADMIN_MODE = true;
            }
            
            updateAdminModeUI(); 
            
            const stories = getSavedStoriesFinal(); 
            renderSavedStories(); 
            
            const firstStoryId = Object.keys(stories)[0];
            if (firstStoryId) { loadStory(firstStoryId); } else { resetStudyArea(); }
            
            const rateSlider = document.getElementById('speech-rate');
            const rateDisplay = document.getElementById('rate-display');
            rateSlider.oninput = () => { rateDisplay.textContent = `${rateSlider.value}x`; };
        });
        
    </script>
</body>
</html>
